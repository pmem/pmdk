# Run all tests on PMEM.
#
# This workflow is run on 'self-hosted' runners.
name: PMEM tests

on:
  workflow_dispatch:
  schedule:
    # run this job at 18:00 UTC every day
    - cron:  '0 18 * * *'

jobs:

  # Test the default build with force-enabled Valgrind tooling for (persistent)
  # memory error detection.
  Memory:
    uses: ./.github/workflows/pmem_test_matrix.yml
    with:
      force_enable: '["pmemcheck", "memcheck"]'

  no_valgrind:
    name: Without Valgrind
    if: github.repository == 'pmem/pmdk'
    runs-on: [self-hosted, "${{ matrix.os }}"]
    strategy:
      fail-fast: true
      matrix:
        os: [rhel, opensuse]

    steps:
      - uses: actions/checkout@v4

      - name: Test prepare
        uses: ./.github/actions/pmem_test_prepare
        with:
          ndctl_enable: y
          valgrind: 0

      - name: Test run
        uses: ./.github/actions/pmem_test_run
        with:
          build: nondebug # only the production build is considered

  no_valgrind_pmemcheck:
    name: Pmemcheck without Valgrind
    if: github.repository == 'pmem/pmdk'
    runs-on: [self-hosted, "${{ matrix.os }}"]
    strategy:
      fail-fast: true
      matrix:
        os: [rhel, opensuse]

    steps:
      - uses: actions/checkout@v4

      - name: Test prepare
        uses: ./.github/actions/pmem_test_prepare
        with:
          ndctl_enable: y
          valgrind: 0

      - name: Test run
        uses: ./.github/actions/pmem_test_run
        with:
          build: nondebug # only the production build is considered
          force_enable: pmemcheck

  no_valgrind_memcheck:
    name: Memcheck without Valgrind
    if: github.repository == 'pmem/pmdk'
    runs-on: [self-hosted, "${{ matrix.os }}"]
    strategy:
      fail-fast: true
      matrix:
        os: [rhel, opensuse]

    steps:
      - uses: actions/checkout@v4

      - name: Test prepare
        uses: ./.github/actions/pmem_test_prepare
        with:
          ndctl_enable: y
          valgrind: 0

      - name: Test run
        uses: ./.github/actions/pmem_test_run
        with:
          build: nondebug # only the production build is considered
          force_enable: memcheck
